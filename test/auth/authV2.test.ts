import {describe} from "mocha";

const path = require("path");
const wasm_tester = require("circom_tester").wasm;

// inputs MUST be generated by GO-CIRCUITS library https://github.com/iden3/go-circuits (using corresponding test)
describe("authV2Test.circom:", async function() {

    const tests = [
        {
            desc: "Ownership true. User state: genesis. Auth claims total/signedWith/revoked: 1/1/none",
            input: {
                userGenesisID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
                nonce: "10",
                userAuthClaim: ["304427537360709784173770334266246861770", "0", "17640206035128972995519606214765283372613874593503528180869261482403155458945", "20634138280259599560273310290025659992320584624461316485434108770067472477956", "15930428023331155902", "0", "0", "0"],
                userAuthClaimMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtpAuxHi: "0",
                userAuthClaimNonRevMtpAuxHv: "0",
                userAuthClaimNonRevMtpNoAux: "1",
                challenge: "6110517768249559238193477435454792024732173865488900270849624328650765691494",
                challengeSignatureR8x: "2273647433349372574162365571517182161856978101733725351784171216877260126349",
                challengeSignatureR8y: "20921152258050920729820249883788091534543872328111915977763626674391221282579",
                challengeSignatureS: "1281122186572874955530253539759994983000852038854525332258204958436946993067",
                userClaimsTreeRoot: "9763429684850732628215303952870004997159843236039795272605841029866455670219",
                userRevTreeRoot: "0",
                userRootsTreeRoot: "0",
                userState: "18656147546666944484453899241916469544090258810192803949522794490493271005313",
                globalSmtRoot: "8654801164827267300505642792609108116741757079309873831472910903288030796079",
                globalSmtMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                globalSmtMtpAuxHi: "24225204644786657620626565452898941426026601178354142146799363069935288320",
                globalSmtMtpAuxHv: "1257746809182882563786560928809910818663538703587513060503018952434273712929",
                globalSmtMtpNoAux: "0",
            },
            output: {
                userID: "19224224881555258540966250468059781351205177043309252290095510834143232000",
            },
        },
        {
            desc: "Ownership true. User state: not-genesis. Auth claims total/signedWith/revoked: 1/1/none",
            input: {
                challenge: "1",
                challengeSignatureR8x: "8553678144208642175027223770335048072652078621216414881653012537434846327449",
                challengeSignatureR8y: "5507837342589329113352496188906367161790372084365285966741761856353367255709",
                challengeSignatureS: "2093461910575977345603199789919760192811763972089699387324401771367839603655",
                globalSmtMtp: ["6423726522886114660660988997089256319591919429389541858046392552123009603801", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                globalSmtMtpAuxHi: "0",
                globalSmtMtpAuxHv: "0",
                globalSmtMtpNoAux: "0",
                globalSmtRoot: "6755261816440190753884475013204208372458542357878351547339749054273475091177",
                nonce: "10",
                userAuthClaim: ["304427537360709784173770334266246861770", "0", "17640206035128972995519606214765283372613874593503528180869261482403155458945", "20634138280259599560273310290025659992320584624461316485434108770067472477956", "15930428023331155902", "0", "0", "0"],
                userAuthClaimMtp: ["0", "0", "1243904711429961858774220647610724273798918457991486031567244100767259239747", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtpAuxHi: "0",
                userAuthClaimNonRevMtpAuxHv: "0",
                userAuthClaimNonRevMtpNoAux: "1",
                userClaimsTreeRoot: "3325296375493109531775738970103865437471502880293182874312109748701010548081",
                userGenesisID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
                userRevTreeRoot: "0",
                userRootsTreeRoot: "0",
                userState: "21556156816336611928260850205358242317673071374695788694657164635542250181506",
            },
            output: {
                userID: "19224224881555258540966250468059781351205177043309252290095510834143232000",
            },
        },
        {
            desc: "Ownership true. User state: not-genesis. Auth claims total/signedWith/revoked: 2/2/none",
            input: {
                challenge: "1",
                challengeSignatureR8x: "3318605682427930847043923964996627571509054270532204838981931388121839601904",
                challengeSignatureR8y: "6885828942356963641443098413925008636428756893590364657052219244852107012379",
                challengeSignatureS: "1239257276045842588253148642684748186882810960469506371777432113478495615573",
                globalSmtMtp: ["6423726522886114660660988997089256319591919429389541858046392552123009603801", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                globalSmtMtpAuxHi: "0",
                globalSmtMtpAuxHv: "0",
                globalSmtMtpNoAux: "0",
                globalSmtRoot: "8831560413047856257085259027212552303747484757282654870676047868211472157913",
                userAuthClaim: ["304427537360709784173770334266246861770", "0", "4720763745722683616702324599137259461509439547324750011830105416383780791263", "4844030361230692908091131578688419341633213823133966379083981236400104720538", "16547485850637761685", "0", "0", "0"],
                userAuthClaimMtp: ["20414019172782894011037632981443152254877376319211511372476935057674492820400", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtpAuxHi: "0",
                userAuthClaimNonRevMtpAuxHv: "0",
                userAuthClaimNonRevMtpNoAux: "1",
                userClaimsTreeRoot: "4007604929687835641683076505379836604617083797856462347907321779859723516350",
                userGenesisID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
                userRevTreeRoot: "0",
                userRootsTreeRoot: "0",
                nonce: "123456789",
                userState: "17722469129507053741573719341978204391758087537322007148901451934391296362335",
            },
            output: {
                userID: "23389546136571627171255717487319086739228893870762611108867450955921227776",
            },
        },
        {
            desc: "nonce=0. ProfileID == UserID should be true. Ownership true. User state: genesis. Auth claims total/signedWith/revoked: 1/1/none",
            input: {
                challenge: "1",
                challengeSignatureR8x: "3318605682427930847043923964996627571509054270532204838981931388121839601904",
                challengeSignatureR8y: "6885828942356963641443098413925008636428756893590364657052219244852107012379",
                challengeSignatureS: "1239257276045842588253148642684748186882810960469506371777432113478495615573",
                globalSmtMtp: ["6423726522886114660660988997089256319591919429389541858046392552123009603801", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                globalSmtMtpAuxHi: "0",
                globalSmtMtpAuxHv: "0",
                globalSmtMtpNoAux: "0",
                globalSmtRoot: "19638862148152134254552118025664465770449697412399425765337173640617797627777",
                nonce: "0",
                userAuthClaim: ["304427537360709784173770334266246861770", "0", "4720763745722683616702324599137259461509439547324750011830105416383780791263", "4844030361230692908091131578688419341633213823133966379083981236400104720538", "16547485850637761685", "0", "0", "0"],
                userAuthClaimMtp: ["20414019172782894011037632981443152254877376319211511372476935057674492820400", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtpAuxHi: "15930428023331155902",
                userAuthClaimNonRevMtpAuxHv: "0",
                userAuthClaimNonRevMtpNoAux: "0",
                userClaimsTreeRoot: "4007604929687835641683076505379836604617083797856462347907321779859723516350",
                userGenesisID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
                userRevTreeRoot: "9572161194792737168173461511232528826921561251689921703982232129896045083154",
                userRootsTreeRoot: "0",
                userState: "33089667707925197893198548712099817576974852353032974911703174608178861050",
            },
            output: {
                userID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
            },
        },
        {
            desc: "nonce=10. ProfileID == UserID should be true. Ownership true. User state: genesis. Auth claims total/signedWith/revoked: 1/1/none",
            input: {
                challenge: "1",
                challengeSignatureR8x: "8553678144208642175027223770335048072652078621216414881653012537434846327449",
                challengeSignatureR8y: "5507837342589329113352496188906367161790372084365285966741761856353367255709",
                challengeSignatureS: "2093461910575977345603199789919760192811763972089699387324401771367839603655",
                globalSmtMtp: ["6423726522886114660660988997089256319591919429389541858046392552123009603801", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                globalSmtMtpAuxHi: "0",
                globalSmtMtpAuxHv: "0",
                globalSmtMtpNoAux: "1",
                globalSmtRoot: "2960269998131412406135915396987536312795307713692807443361231572350088373156",
                userAuthClaim: ["304427537360709784173770334266246861770", "0", "17640206035128972995519606214765283372613874593503528180869261482403155458945", "20634138280259599560273310290025659992320584624461316485434108770067472477956", "15930428023331155902", "0", "0", "0"],
                userAuthClaimMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
                userAuthClaimNonRevMtpAuxHi: "0",
                userAuthClaimNonRevMtpAuxHv: "0",
                userAuthClaimNonRevMtpNoAux: "1",
                userClaimsTreeRoot: "9763429684850732628215303952870004997159843236039795272605841029866455670219",
                userGenesisID: "20920305170169595198233610955511031459141100274346276665183631177096036352",
                userRevTreeRoot: "0",
                userRootsTreeRoot: "0",
                nonce: "10",
                userState: "18656147546666944484453899241916469544090258810192803949522794490493271005313",
            },
            output: {
                userID: "19224224881555258540966250468059781351205177043309252290095510834143232000",
                challenge: "1",
                globalSmtRoot: "2960269998131412406135915396987536312795307713692807443361231572350088373156",

            },
        },
    ];

    let circuit;
    this.timeout(300000)

    before(async () => {
        circuit = await wasm_tester(
            path.join(__dirname, "../circuits", "authV2Test.circom"),
            {
                output: path.join(__dirname, "../circuits", "build/authV2"),
                recompile: true,
                reduceConstraints: false,
            },
        );
    });

    tests.forEach(({desc, input, output}) => {
        it(`auth ${desc}`, async function() {
            const w = await circuit.calculateWitness(input, true);
            await circuit.checkConstraints(w);
            await circuit.assertOut(w, output);
        });
    });
});
