import {describe} from "mocha";

const path = require("path");
const wasm_tester = require("circom_tester").wasm;

// inputs MUST be generated by GO-CIRCUITS library https://github.com/iden3/go-circuits (using corresponding test)
describe("authV2Test.circom:", async function() {

    const tests = [
        {desc: "Ownership true. User state: not-genesis. Auth claims total/signedWith/revoked: 1/1/none", inputs: {userGenesisID: "24357338057394103910029868244681596615276666879950910837900400354886746113", nonce: "0", userAuthClaim: ["304427537360709784173770334266246861770", "0", "4720763745722683616702324599137259461509439547324750011830105416383780791263", "4844030361230692908091131578688419341633213823133966379083981236400104720538", "16547485850637761685", "0", "0", "0"], userAuthClaimMtp: ["15199473115813230313374914807082214428877572421391930598963399134225175436873", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtpAuxHi: "0", userAuthClaimNonRevMtpAuxHv: "0", userAuthClaimNonRevMtpNoAux: "1", challenge: "12345", challengeSignatureR8x: "15829360093371098546177008474519342171461782120259125067189481965541223738777", challengeSignatureR8y: "10840522802382821290541462398953040493080116495308402635486440290351677745960", challengeSignatureS: "1196477404779941775725836688033485533497812196897664950083199167075327114562", userClaimsTreeRoot: "8835348074549209004167024957400258890451734046567123115843748505080264857547", userRevTreeRoot: "0", userRootsTreeRoot: "0", userState: "15272921596805856845477887675756517945512853821918245545311480821797051913969", gistRoot: "10340560968280066998147414943045472957325918708534216694863558122616429210963", gistMtp: ["0", "1243904711429961858774220647610724273798918457991486031567244100767259239747", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], gistMtpAuxHi: "0", gistMtpAuxHv: "0", gistMtpNoAux: "0"}, expOut: {userID: "24357338057394103910029868244681596615276666879950910837900400354886746113", gistRoot: "10340560968280066998147414943045472957325918708534216694863558122616429210963", challenge: "12345"}},
        {desc: "Ownership true. User state: not-genesis. Auth claims total/signedWith/revoked: 1/1/none", inputs: {userGenesisID: "24357338057394103910029868244681596615276666879950910837900400354886746113", nonce: "0", userAuthClaim: ["304427537360709784173770334266246861770", "0", "18843627616807347027405965102907494712213509184168391784663804560181782095821", "21769574296201138406688395494914474950554632404504713590270198507141791084591", "17476719578317212277", "0", "0", "0"], userAuthClaimMtp: ["16935233905999379395228879484629933212061337894505747058350106225580401780334", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtpAuxHi: "16547485850637761685", userAuthClaimNonRevMtpAuxHv: "0", userAuthClaimNonRevMtpNoAux: "0", challenge: "12345", challengeSignatureR8x: "17119525341148708510056742833108899809180137847226842265134929121642912372281", challengeSignatureR8y: "14361124785409490066314019246273984594356444175220864488356627192969301706799", challengeSignatureS: "1437929958210592098523189041037049993330511094749287599959220159702091719018", userClaimsTreeRoot: "8835348074549209004167024957400258890451734046567123115843748505080264857547", userRevTreeRoot: "18174590471735654296853614985726184006995378344929215927298747263240370223984", userRootsTreeRoot: "0", userState: "13606968899339239555673721111116546468910444929931671186177415533068740167100", gistRoot: "18566740406712404941365850293772561531736552738085525756427189528392188090775", gistMtp: ["0", "1243904711429961858774220647610724273798918457991486031567244100767259239747", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], gistMtpAuxHi: "0", gistMtpAuxHv: "0", gistMtpNoAux: "0"}, expOut: {userID: "24357338057394103910029868244681596615276666879950910837900400354886746113", gistRoot: "18566740406712404941365850293772561531736552738085525756427189528392188090775", challenge: "12345"}},
        {desc: "Ownership true. User state: genesis. Auth claims total/signedWith/revoked: 1/1/none", inputs: {userGenesisID: "24357338057394103910029868244681596615276666879950910837900400354886746113", nonce: "0", userAuthClaim: ["304427537360709784173770334266246861770", "0", "4720763745722683616702324599137259461509439547324750011830105416383780791263", "4844030361230692908091131578688419341633213823133966379083981236400104720538", "16547485850637761685", "0", "0", "0"], userAuthClaimMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtpAuxHi: "0", userAuthClaimNonRevMtpAuxHv: "0", userAuthClaimNonRevMtpNoAux: "1", challenge: "12345", challengeSignatureR8x: "15829360093371098546177008474519342171461782120259125067189481965541223738777", challengeSignatureR8y: "10840522802382821290541462398953040493080116495308402635486440290351677745960", challengeSignatureS: "1196477404779941775725836688033485533497812196897664950083199167075327114562", userClaimsTreeRoot: "16935233905999379395228879484629933212061337894505747058350106225580401780334", userRevTreeRoot: "0", userRootsTreeRoot: "0", userState: "18038855432424775233659896904370825175764119936950028950189276486279006981491", gistRoot: "1243904711429961858774220647610724273798918457991486031567244100767259239747", gistMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], gistMtpAuxHi: "1", gistMtpAuxHv: "1", gistMtpNoAux: "0"}, expOut: {userID: "24357338057394103910029868244681596615276666879950910837900400354886746113", gistRoot: "1243904711429961858774220647610724273798918457991486031567244100767259239747", challenge: "12345"}},
        {desc: "nonce=10. ProfileID == UserID should be true. Ownership true. User state: genesis. Auth claims total/signedWith/revoked: 1/1/none", inputs: {userGenesisID: "24357338057394103910029868244681596615276666879950910837900400354886746113", nonce: "10", userAuthClaim: ["304427537360709784173770334266246861770", "0", "4720763745722683616702324599137259461509439547324750011830105416383780791263", "4844030361230692908091131578688419341633213823133966379083981236400104720538", "16547485850637761685", "0", "0", "0"], userAuthClaimMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], userAuthClaimNonRevMtpAuxHi: "0", userAuthClaimNonRevMtpAuxHv: "0", userAuthClaimNonRevMtpNoAux: "1", challenge: "12345", challengeSignatureR8x: "15829360093371098546177008474519342171461782120259125067189481965541223738777", challengeSignatureR8y: "10840522802382821290541462398953040493080116495308402635486440290351677745960", challengeSignatureS: "1196477404779941775725836688033485533497812196897664950083199167075327114562", userClaimsTreeRoot: "16935233905999379395228879484629933212061337894505747058350106225580401780334", userRevTreeRoot: "0", userRootsTreeRoot: "0", userState: "18038855432424775233659896904370825175764119936950028950189276486279006981491", gistRoot: "1243904711429961858774220647610724273798918457991486031567244100767259239747", gistMtp: ["0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"], gistMtpAuxHi: "1", gistMtpAuxHv: "1", gistMtpNoAux: "0"}, expOut: {userID: "16501380676610282756331962130170908325950918404081458092270009074630918145", gistRoot: "1243904711429961858774220647610724273798918457991486031567244100767259239747", challenge: "12345"}},
    ];

    let circuit;
    this.timeout(300000)

    before(async () => {
        circuit = await wasm_tester(
            path.join(__dirname, "../circuits", "authV2Test.circom"),
            {
                output: path.join(__dirname, "../circuits", "build/authV2"),
                recompile: true,
                reduceConstraints: false,
            },
        );
    });

    tests.forEach(({desc, inputs, expOut}) => {
        it(`auth ${desc}`, async function() {
            const w = await circuit.calculateWitness(inputs, true);
            await circuit.checkConstraints(w);
            await circuit.assertOut(w, expOut);
        });
    });
});
